<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aplikasi Absensi Guru MDTA</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#2E7D32; --bg2:#FF9800; --accent:#A5D6A7; --txt:#E0E0E0;
}
*{box-sizing:border-box;}
body{
  font-family:'Poppins',sans-serif;
  margin:0; min-height:100vh;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  display:flex; align-items:center; justify-content:center; padding:20px; color:var(--txt);
}
.card, #absensi{
  background:rgba(255,255,255,0.08);
  border-radius:16px; padding:24px; width:100%; max-width:460px; backdrop-filter:blur(8px);
  border:1px solid rgba(255,255,255,0.08);
}
h2{margin:0 0 14px 0; font-size:1.6rem; color:#fff;}
.input-group{margin:12px 0;}
input, select, button{width:100%; padding:10px 12px; border-radius:10px; border:none; font-size:15px;}
input, select{background:rgba(255,255,255,0.06); color:var(--txt);}
button{
  background:linear-gradient(45deg,var(--accent),#81C784);
  color:#fff; font-weight:700; cursor:pointer; margin-top:10px;
  position:relative; z-index:9999;
}
button:disabled{background:#666; cursor:not-allowed;}
#printBtn{background:linear-gradient(45deg,#FF9800,#FB8C00);}
#camera{width:100%; border-radius:12px; margin:12px 0; max-height:320px; object-fit:cover; border:3px solid var(--accent);}
.keterangan{font-size:13px; text-align:left; margin-top:12px; background:rgba(255,255,255,0.03); padding:10px; border-radius:8px;}
.keterangan span{display:block; margin:4px 0;}
#rekap{margin-top:14px;}
table{width:100%; border-collapse:collapse; margin-top:10px; background:rgba(255,255,255,0.03);}
th, td{padding:8px; border:1px solid rgba(255,255,255,0.06); font-size:13px; text-align:center; color:var(--txt);}
th{background:rgba(255,255,255,0.02); color:var(--accent); font-weight:700;}
.stats{margin-top:10px; font-weight:700; color:var(--accent);}
.popup{display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center;}
.popup .box{background:#fff; color:#222; padding:18px; border-radius:12px; width:90%; max-width:360px; text-align:center;}
.popup button{margin-top:12px; padding:8px 18px; border-radius:8px; background:#2E7D32; color:#fff; border:none;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="welcome" class="card">
  <h2>Login Guru</h2>
  <div class="input-group"><input id="username" type="text" placeholder="Username"></div>
  <div class="input-group"><input id="password" type="password" placeholder="Password"></div>
  <button id="loginBtn" onclick="login()">Login</button>
</div>

<!-- ABSENSI -->
<div id="absensi" class="card" style="display:none;">
  <h2>Absensi Harian</h2>

  <video id="camera" autoplay playsinline muted></video>

  <div class="input-group">
    <select id="bulanSelect" onchange="bulanDipilih()">
      <option value="">--Pilih Bulan--</option>
      <option value="0">Januari</option><option value="1">Februari</option>
      <option value="2">Maret</option><option value="3">April</option>
      <option value="4">Mei</option><option value="5">Juni</option>
      <option value="6">Juli</option><option value="7">Agustus</option>
      <option value="8">September</option><option value="9">Oktober</option>
      <option value="10">November</option><option value="11">Desember</option>
    </select>
  </div>

  <button id="btnAbsen" disabled>Ambil Absen</button>
  <button id="btnPrint" onclick="printRekap()" disabled>Print Rekap Bulanan</button>
  <p id="status" style="margin-top:8px;"></p>

  <div class="keterangan">
    <span>üïí Pilih bulan dulu sebelum bisa absen</span>
    <span>‚û° Absen otomatis Datang / Pulang (per tanggal)</span>
    <span id="ketArea" style="color:#4CAF50;">üìç Absen tanpa batasan lokasi</span>
    <span>üì∑ Selfie otomatis disimpan</span>
  </div>

  <div id="rekap"></div>
  <div class="stats" id="stats"></div>
</div>

<!-- Popup -->
<div id="popup" class="popup"><div class="box"><p id="popup-message"></p><button onclick="closePopup()">OK</button></div></div>

<script>
/* ---------- data & konstanta ---------- */
const guruAkun = [{username:"guru1", password:"123"},{username:"guru2", password:"456"}];
let guruAktif = null;
const bulanNama = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
const hariNama = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];

/* ---------- helper ---------- */
function pad2(n){return String(n).padStart(2,'0');}
function isoFromDate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function displayDateFromISO(iso){
  const parts = iso.split('-'); if(parts.length!==3) return iso;
  const y=parseInt(parts[0],10), m=parseInt(parts[1],10)-1, dd=parseInt(parts[2],10);
  return `${dd} ${bulanNama[m]} ${y}`;
}
function dayNameFromISO(iso){
  const parts = iso.split('-'); if(parts.length!==3) return '';
  const y=parseInt(parts[0],10), m=parseInt(parts[1],10)-1, dd=parseInt(parts[2],10);
  const dt = new Date(y,m,dd);
  return hariNama[dt.getDay()];
}
function showPopup(msg){
  document.getElementById('popup-message').innerHTML = msg;
  document.getElementById('popup').style.display = 'flex';
}
function closePopup(){ document.getElementById('popup').style.display = 'none'; }

/* ---------- login & camera ---------- */
function login(){
  const user = document.getElementById('username').value.trim();
  const pass = document.getElementById('password').value.trim();
  const found = guruAkun.find(g => g.username === user && g.password === pass);
  if(!found){ showPopup('Login gagal! Username atau password salah.'); return; }
  guruAktif = user;
  document.getElementById('welcome').style.display = 'none';
  document.getElementById('absensi').style.display = 'block';
  startCamera();

  document.getElementById('bulanSelect').value = '';
  document.getElementById('btnAbsen').disabled = true;
  document.getElementById('btnPrint').disabled = true;
  document.getElementById('status').innerText = '';
  document.getElementById('rekap').innerHTML = '';
  document.getElementById('stats').innerText = '';

  // support klik & sentuh
  const absenBtn = document.getElementById("btnAbsen");
  absenBtn.addEventListener("click", absen);
}

/* ---------- camera ---------- */
function startCamera(){
  const video = document.getElementById('camera');
  if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
      .then(stream => { video.srcObject = stream; })
      .catch(err => { showPopup('Kamera tidak bisa diakses: ' + err.message); });
  } else {
    showPopup('Browser tidak mendukung kamera.');
  }
}

/* ---------- bulan selection ---------- */
function bulanDipilih(){
  const val = document.getElementById('bulanSelect').value;
  const enable = (val !== '');
  document.getElementById('btnAbsen').disabled = !enable;
  document.getElementById('btnPrint').disabled = !enable;
  tampilkanRekap();
}

/* ---------- absen ---------- */
function absen(){
  if(!guruAktif){ showPopup('Silakan login terlebih dahulu.'); return; }
  const bulanVal = document.getElementById('bulanSelect').value;
  if(bulanVal === ''){ showPopup('Silakan pilih bulan terlebih dahulu.'); return; }

  // langsung simpan tanpa cek lokasi
  document.getElementById('ketArea').style.color = '#4CAF50';
  captureAndSave(bulanVal);
}

function captureAndSave(bulanVal){
  const video = document.getElementById('camera');
  const canvas = document.createElement('canvas');
  const vw = video.videoWidth || 640;
  const vh = video.videoHeight || 480;
  canvas.width = vw;
  canvas.height = vh;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const foto = canvas.toDataURL('image/png');

  const now = new Date();
  const iso = isoFromDate(now);
  const displayDate = displayDateFromISO(iso);
  const dayName = dayNameFromISO(iso);
  const jam = now.toLocaleTimeString();
  const tahun = now.getFullYear();

  const dataAll = JSON.parse(localStorage.getItem('rekap')) || [];
  const sudahDatang = dataAll.find(r => r.guru === guruAktif && r.isoDate === iso && r.jenis === 'Datang' && String(r.month) === String(bulanVal) && r.year === tahun);
  const jenis = sudahDatang ? 'Pulang' : 'Datang';
  const status = 'Hadir';

  const rec = {
    guru: guruAktif,
    isoDate: iso,
    displayDate: displayDate,
    dayName: dayName,
    jam: jam,
    status: status,
    jenis: jenis,
    foto: foto,
    month: Number(bulanVal),
    year: tahun
  };

  dataAll.push(rec);
  localStorage.setItem('rekap', JSON.stringify(dataAll));

  document.getElementById('status').innerText = `Status: ${status} (${jenis})`;
  tampilkanRekap();
}

/* ---------- tampil rekap ---------- */
function tampilkanRekap(){
  const dataAll = JSON.parse(localStorage.getItem('rekap')) || [];
  const bulanVal = document.getElementById('bulanSelect').value;
  if(!guruAktif || bulanVal === ''){
    document.getElementById('rekap').innerHTML = '';
    document.getElementById('stats').innerText = '';
    return;
  }
  const tahun = new Date().getFullYear();
  const monthIdx = Number(bulanVal);
  const filtered = dataAll.filter(r => r.guru === guruAktif && Number(r.month) === monthIdx && r.year === tahun);

  if(filtered.length === 0){
    document.getElementById('rekap').innerHTML = '';
    document.getElementById('stats').innerText = 'Belum ada data untuk bulan ini.';
    return;
  }

  let html = `<h3 style="margin:8px 0 6px 0;color:#fff">Rekap Bulan ${bulanNama[monthIdx]} ${tahun}</h3>`;
  html += `<table><thead><tr><th>Hari</th><th>Tanggal</th><th>Jam</th><th>Status</th><th>Jenis</th><th>Foto</th></tr></thead><tbody>`;
  filtered.forEach(r => {
    html += `<tr>
      <td>${r.dayName}</td>
      <td>${r.displayDate}</td>
      <td>${r.jam}</td>
      <td>${r.status}</td>
      <td>${r.jenis}</td>
      <td><img src="${r.foto}" width="50" style="border-radius:6px;"/></td>
    </tr>`;
  });
  html += `</tbody></table>`;
  document.getElementById('rekap').innerHTML = html;

  const totalHadir = filtered.filter(r=>r.status === 'Hadir').length;
  const totalDatang = filtered.filter(r=>r.jenis === 'Datang').length;
  const totalPulang = filtered.filter(r=>r.jenis === 'Pulang').length;
  document.getElementById('stats').innerText = `Total baris: ${filtered.length} | Datang: ${totalDatang} | Pulang: ${totalPulang} | Hadir: ${totalHadir}`;
}

/* ---------- print rekap ---------- */
function printRekap(){
  if(!guruAktif){ showPopup('Silakan login dulu'); return; }
  const bulanVal = document.getElementById('bulanSelect').value;
  if(bulanVal === ''){ showPopup('Pilih bulan dulu'); return; }
  const tahun = new Date().getFullYear();
  const monthIdx = Number(bulanVal);

  const dataAll = JSON.parse(localStorage.getItem('rekap')) || [];
  const filtered = dataAll.filter(r => r.guru === guruAktif && Number(r.month) === monthIdx && r.year === tahun);
  if(filtered.length === 0){ showPopup('Tidak ada data untuk dicetak pada bulan ini.'); return; }

  const w = window.open('', '_blank', 'width=900,height=700');
  const style = `
    <style>
      body{font-family:Arial,Helvetica,sans-serif;color:#000;margin:20px;}
      h2{margin-bottom:6px;}
      table{border-collapse:collapse;width:100%;}
      th,td{border:1px solid #444;padding:6px;font-size:13px;text-align:center;}
      th{background:#eee;}
      img{border-radius:6px;}
    </style>
  `;
  const header = `<h2>Rekap Absensi Guru ${guruAktif} - ${bulanNama[monthIdx]} ${tahun}</h2>`;
  let table = `<table><thead><tr><th>Hari</th><th>Tanggal</th><th>Jam</th><th>Status</th><th>Jenis</th><th>Foto</th></tr></thead><tbody>`;
  filtered.forEach(r => {
    table += `<tr>
      <td>${r.dayName}</td>
      <td>${r.displayDate}</td>
      <td>${r.jam}</td>
      <td>${r.status}</td>
      <td>${r.jenis}</td>
      <td><img src="${r.foto}" width="60"></td>
    </tr>`;
  });
  table += `</tbody></table>`;

  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Rekap ${guruAktif}</title>${style}</head><body>${header}${table}</body></html>`);
  w.document.close();
  w.focus();
  setTimeout(()=>{ w.print(); }, 500);
}
</script>
</body>
</html>
